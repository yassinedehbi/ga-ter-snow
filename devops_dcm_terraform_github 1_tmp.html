<!DOCTYPE html>
<html>

<head>
    <title>devops_dcm_terraform_github 1.md</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    
<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

html,footer,header{
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Custom MD PDF CSS
 */
html,footer,header{
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";

 }
body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>
<link rel="stylesheet" href="file:///home/issam/ga-ter-snow/R%3A%5C2.Travail%5C1.Enseignement%5CCours%5C_1.Outils%5C2.Developpement%5C1.SCSS%5Cmain.css" type="text/css"><link rel="stylesheet" href="file:///home/issam/ga-ter-snow/D%3A%5Crdaros%5CCours%5C_1.Outils%5C2.Developpement%5C1.SCSS%5Cmain.css" type="text/css">
</head>

<body>
    <h1 id="devops-database-change-management-with-terraform-and-github">DevOps: Database Change Management with Terraform and GitHub</h1>
<!-- ------------------------ -->
<h2 id="overview">Overview</h2>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-1.png" width="600">
<p>This quickstart will provide step-by-step instructions for how to build a simple CI/CD pipeline for Snowflake with GitHub Actions and Terraform. My hope is that this will provide you with enough details to get you started on your DevOps journey with Snowflake, GitHub Actions, and Terraform.</p>
<p>DevOps is concerned with automating the development, release and maintenance of software applications. As such, DevOps is very broad and covers the entire Software Development Life Cycle (SDLC). The landscape of software tools used to manage the entire SDLC is complex since there are many different required capabilities/tools, including:</p>
<ul>
<li>Requirements management</li>
<li>Project management (Waterfall, Agile/Scrum)</li>
<li>Source code management (Version Control)</li>
<li>Build management (CI/CD)</li>
<li>Test management (CI/CD)</li>
<li>Release management (CI/CD)</li>
</ul>
<p>This quickstart will focus primarily on automated release management for Snowflake by leveraging the GitHub Actions service from GitHub for the CI/CD and Terraform for the Database Change Management. Database Change Management (DCM) refers to a set of processes and tools which are used to manage the objects within a database.</p>
<blockquote>
<p><strong>Tip</strong> - For a more complete introduction to using Terraform with Snowflake, please check  <a href="https://quickstarts.snowflake.com/guide/terraforming_snowflake/index.html?index=..%2F..index#0">Terraforming Snowflake</a>.</p>
</blockquote>
<p>Let’s begin with a brief overview of GitHub and Terraform.</p>
<h3 id="what-youll-need">What You'll Need</h3>
<p>You will need the following things before beginning:</p>
<ol>
<li>Snowflake</li>
<li><strong>A Snowflake Account.</strong></li>
<li><strong>A Snowflake User created with appropriate permissions.</strong> This user will need permission to create databases.</li>
<li>GitHub</li>
<li><strong>A GitHub Account.</strong> If you don’t already have a GitHub account you can create one for free. Visit the <a href="https://github.com/join">Join GitHub</a> page to get started.</li>
<li><strong>A GitHub Repository.</strong> If you don't already have a repository created, or would like to create a new one, then <a href="https://github.com/new">Create a new respository</a>. For the type, select <code>Public</code> (although you could use either). And you can skip adding the README, .gitignore and license for now.</li>
<li>Terraform Cloud</li>
<li><strong>A Terraform Cloud Account.</strong> If you don't already have a Terraform Cloud account you can create on for free. Visit the <a href="https://app.terraform.io/signup/account">Create an account</a> page to get started.</li>
<li>Integrated Development Environment (IDE)</li>
<li><strong>Your favorite IDE with Git integration.</strong> If you don’t already have a favorite IDE that integrates with Git I would recommend the great, free, open-source <a href="https://code.visualstudio.com/">Visual Studio Code</a>.</li>
<li><strong>Your project repository cloned to your computer.</strong> For connection details about your Git repository, open the Repository and copy the <code>HTTPS</code> link provided near the top of the page. If you have at least one file in your repository then click on the green <code>Code</code> icon near the top of the page and copy the <code>HTTPS</code> link. Use that link in VS Code or your favorite IDE to clone the repo to your computer.</li>
</ol>
<!-- ------------------------ -->
<h2 id="github-overview">GitHub Overview</h2>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-3.png" width="250">
<h3 id="github-actions">GitHub Actions</h3>
<p>&quot;GitHub Actions makes it easy to automate all your software workflows, now with world-class CI/CD. Build, test, and deploy your code right from GitHub. Make code reviews, branch management, and issue triaging work the way you want&quot; (from GitHub’s <a href="https://github.com/features/actions">GitHub Actions</a>). GitHub Actions was <a href="https://github.blog/2018-10-16-future-of-software/">first announced in October 2018</a> and has since become a popular CI/CD tool. To learn more about GitHub Actions, including migrating from other popular CI/CD tools to GitHub Actions check out <a href="https://docs.github.com/en/actions/learn-github-actions">Learn GitHub Actions</a>.</p>
<p>This quickstart will be focused on the GitHub Actions service.</p>
<!-- ------------------------ -->
<h2 id="terraform-overview">Terraform Overview</h2>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-4.png" width="250">
<h3 id="terraform">Terraform</h3>
<p><a href="https://www.terraform.io/">Terraform</a> is an open-source Infrastructure as Code (IaC) tool created by <a href="https://www.hashicorp.com/">HashiCorp</a> that &quot;allows you to build, change, and version infrastructure safely and efficiently. This includes low-level components such as compute instances, storage, and networking, as well as high-level components such as DNS entries, SaaS features, etc. Terraform can manage both existing service providers and custom in-house solutions.&quot; (from <a href="https://www.terraform.io/intro/index.html">Introduction to Terraform</a>). With Terraform the primary way to describe your infrastructure is by creating human-readble, declarative configuration files using the high-level configuration language known as <a href="https://www.terraform.io/docs/language/index.html">HashiCorp Configuration Language (HCL)</a>.</p>
<h3 id="terraform-cloud">Terraform Cloud</h3>
<p>&quot;Terraform Cloud is HashiCorp’s managed service offering that eliminates the need for unnecessary tooling and documentation to use Terraform in production. Provision infrastructure securely and reliably in the cloud with free remote state storage. As you scale, add workspaces for better collaboration with your team.&quot; (from <a href="https://www.terraform.io/cloud">Why Terraform Cloud?</a>)</p>
<p>Some of the key features include (from <a href="https://www.terraform.io/cloud">Why Terraform Cloud?</a>):</p>
<ul>
<li><strong>Remote state storage</strong>: Store your Terraform state file securely with encryption at rest. Track infrastructure changes over time, and restrict access to certain teams within your organization.</li>
<li><strong>Flexible Workflows</strong>: Run Terraform the way your team prefers. Execute runs from the CLI or a UI, your version control system, or integrate them into your existing workflows with an API.</li>
<li><strong>Version Control (VCS) integration</strong>: Use version control to store and collaborate on Terraform configurations. Terraform Cloud can automate a run as soon as a pull request is merged into a main branch.</li>
<li><strong>Collaborate on infrastructure changes</strong>: Facilitate collaboration on your team. Review and comment on plans prior to executing any change to infrastructure.</li>
</ul>
<!-- ------------------------ -->
<h2 id="setup-and-configure-terraform-cloud">Setup and Configure Terraform Cloud</h2>
<p>As discussed in the Overview section, you will need to have a Terraform Cloud Account for this quickstart. If you don't already have a Terraform Cloud account you can create on for free. Visit the <a href="https://app.terraform.io/signup/account">Create an account</a> page to get started. After you create your account you'll be asked to provide an organization name.</p>
<p>Begin by <a href="https://app.terraform.io/">logging in to your Terraform Cloud account</a>. Please note your organization name, we'll need it later. If you've forgotten, you can find your organization name in the top navigation bar and in the URL.</p>
<h3 id="create-a-new-workspace">Create a new Workspace</h3>
<p>From the Workspaces page click on the &quot;+ New workspace&quot; button near the top right of the page. On the first page, where it asks you to choose the type of workflow, select &quot;API-driven workflow&quot;.</p>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-5.png" width="600">
<p>On the second page, where it asks for the &quot;Workspace Name&quot; enter <code>gh-actions-demo</code> and then click the &quot;Create workspace&quot; button at the bottom of the page.</p>
<h3 id="setup-environment-variables">Setup Environment Variables</h3>
<p>In order for Terraform Cloud to be able to connect to your Snowflake account you'll need to store the settings in Environment variables. Fortunately, Terraform Cloud makes this easy. From your new workspace homepage click on the &quot;Variables&quot; tab. Then for each variable listed below click on &quot;+ Add variable&quot; button (under the &quot;Environment Variables&quot; section) and enter the name given below along with the appropriate value (adjusting as appropriate).</p>
<table>
    <thead>
        <tr>
            <th>Variable key</th>
            <th>Variable value</th>
            <th>Sensitive?</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>SNOWFLAKE_ACCOUNT</td>
            <td>x******</td>
            <td>No</td>
        </tr>
        <tr>
            <td>SNOWFLAKE_REGION</td>
            <td>east-us-2.azure</td>
            <td>No</td>
        </tr>
        <tr>
            <td>SNOWFLAKE_USER</td>
            <td>DEMO_USER</td>
            <td>No</td>
        </tr>
        <tr>
            <td>SNOWFLAKE_PASSWORD</td>
            <td>*****</td>
            <td>Yes</td>
        </tr>
    </tbody>
</table>
<p>When you’re finished adding all the secrets, the page should look like this:</p>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-6.png" width="600">
<h3 id="create-an-api-token">Create an API Token</h3>
<p>The final thing we need to do in Terraform Cloud is to create an API Token so that GitHub Actions can securely authenticate with Terraform Cloud. Click on your user icon near the top right of the screen and then click on &quot;User settings&quot;. Then in the left navigation bar click on the user settings page click on the &quot;Tokens&quot; tab.</p>
<p>Click on the &quot;Create an API token&quot; button, give your token a &quot;Description&quot; (like <code>GitHub Actions</code>) and then click on the &quot;Create API token&quot; button. Pay careful attention on the next screen. You need to save the API token because once you click on the &quot;Done&quot; button the token <strong>will not be displayed again</strong>. Once you've saved the token, click the &quot;Done&quot; button.</p>
<!-- ------------------------ -->
<h2 id="create-the-actions-workflow">Create the Actions Workflow</h2>
<h3 id="create-actions-secrets">Create Actions Secrets</h3>
<p>Action Secrets in GitHub are used to securely store values/variables which will be used in your CI/CD pipelines. In this step we will create a secret to store the API token to Terraform Cloud.</p>
<p>From the repository, click on the &quot;Settings&quot; tab near the top of the page. From the Settings page, click on the &quot;Secrets&quot; tab in the left hand navigation. The &quot;Actions&quot; secrets should be selected.</p>
<p>Click on the &quot;New repository secret&quot; button near the top right of the page. For the secret &quot;Name&quot; enter <code>TF_API_TOKEN</code> and for the &quot;Value&quot; enter the API token value you saved from the previous step.</p>
<h3 id="action-workflows">Action Workflows</h3>
<p>Action Workflows represent automated pipelines, which inludes both build and release pipelines. They are defined as YAML files and stored in your repository in a directory called <code>.github/workflows</code>. In this step we will create a deployment workflow which will run Terraform and deploy changes to our Snowflake account.</p>
<ul>
<li>From the repository, click on the &quot;Actions&quot; tab near the top middle of the page.</li>
<li>Click on the &quot;set up a workflow yourself -&gt;&quot; link (if you already have a workflow defined click on the &quot;new workflow&quot; button and then the &quot;set up a workflow yourself -&gt;&quot; link)</li>
<li>On the new workflow page
<ul>
<li>Name the workflow <code>snowflake-terraform-demo.yml</code></li>
<li>In the &quot;Edit new file&quot; box, replace the contents with the the following:</li>
</ul>
</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-attr">name:</span> <span class="hljs-string">"Snowflake Terraform Demo Workflow"</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">main</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">snowflake-terraform-demo:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">"Snowflake Terraform Demo Job"</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Terraform</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">hashicorp/setup-terraform@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">cli_config_credentials_token:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.TF_API_TOKEN</span> <span class="hljs-string">}}</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Format</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">fmt</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">fmt</span> <span class="hljs-string">-check</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Init</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">init</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">init</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Validate</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">validate</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">validate</span> <span class="hljs-string">-no-color</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Apply</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">apply</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">apply</span> <span class="hljs-string">-auto-approve</span>
</div></code></pre>
<p>Finally, click on the green &quot;Start commit&quot; button near the top right of the page and then click on the green &quot;Commit new file&quot; in the pop up window (you can leave the default comments and commit settings). You'll now be taken to the workflow folder in your repository.</p>
<p>A few things to point out from the YAML pipeline definition:</p>
<ul>
<li>The <code>on:</code> definition configures the pipeline to automatically run when a change is pushed on the <code>main</code> branch of the repository. So any change committed in a different branch will not automatically trigger the workflow to run.</li>
<li>Please note that if you are re-using an existing GitHub repository it might retain the old <code>master</code> branch naming. If so, please update the YAML above (see the <code>on:</code> section).</li>
<li>We’re using the default GitHub-hosted Linux agent to execute the pipeline.</li>
</ul>
<!-- ------------------------ -->
<h2 id="create-your-first-database-migration">Create Your First Database Migration</h2>
<p>Duration: 5</p>
<p>Open up your cloned GitHub repository in your favorite IDE and create a new file in the root named <code>main.tf</code> with the following contents. <em>Please be sure to replace the organization name with your Terraform Cloud organization name.</em></p>
<pre class="hljs"><code><div>terraform {
  required_providers {
    snowflake = {
      source  = &quot;chanzuckerberg/snowflake&quot;
      version = &quot;0.25.17&quot;
    }
  }

  backend &quot;remote&quot; {
    organization = &quot;my-organization-name&quot;

    workspaces {
      name = &quot;gh-actions-demo&quot;
    }
  }
}

provider &quot;snowflake&quot; {
}

resource &quot;snowflake_database&quot; &quot;demo_db&quot; {
  name    = &quot;DEMO_DB&quot;
  comment = &quot;Database for Snowflake Terraform demo&quot;
}
</div></code></pre>
<p>Then commit the new script and push the changes to your GitHub repository. By pushing this commit to our GitHub repository the new workflow we created in the previous step will run automatically.</p>
<!-- ------------------------ -->
<h2 id="confirm-changes-deployed-to-snowflake">Confirm Changes Deployed to Snowflake</h2>
<p>By now your first database migration should have been successfully deployed to Snowflake, and you should now have a <code>DEMO_DB</code> database available. There a few different places that you should check to confirm that everything deployed successfully, or to help you debug in the event that an error happened.</p>
<h3 id="github-actions-log">GitHub Actions Log</h3>
<p>From your repository in GitHub, click on the &quot;Actions&quot; tab. If everything went well, you should see a successful workflow run listed. But either way you should see the run listed under the &quot;All workflows&quot;. To see details about the run click on the run name. From the run overview page you can further click on the job name (it should be <code>Snowflake Terraform Demo Job</code>) in the left hand navigation bar or on the node in the yaml file viewer. Here you can browse through the output from the various steps. In particular you might want to review the output from the <code>Terraform Apply</code> step.</p>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-7.png" width="600">
<h3 id="terraform-cloud-log">Terraform Cloud Log</h3>
<p>While you'll generally be able to see all the Terraform output in the GitHub Actions logs, you may need to also view the logs on Terraform Cloud. From your Terraform Cloud Workspace, click on the &quot;Runs&quot; tab. Here you will see each run listed out, and for the purposes of this quickstart, each run here corresponds to a run in GitHub Actions. Click on the run to open it and view the output from the various steps.</p>
<img src="file:///home/issam/ga-ter-snow/assets/devops_dcm_terraform_github-8.png" width="600">
<h3 id="snowflake-objects">Snowflake Objects</h3>
<p>Log in to your Snowflake account and you should see your new <code>DEMO_DB</code> database! Additionaly you can review the queries that were executed by Terraform by clicking on the &quot;History&quot; tab at the top of the window.</p>
<!-- ------------------------ -->
<h2 id="create-your-second-database-migration">Create Your Second Database Migration</h2>
<p>Now that we've successfully deployed our first change to Snowflake, it's time to make a second one. This time we will add a schema to the <code>DEMO_DB</code> and have it deployed through our automated pipeline.</p>
<p>Open up your cloned repository in your favorite IDE and edit the <code>main.tf</code> file by appending the following lines to end of the file:</p>
<pre class="hljs"><code><div>resource &quot;snowflake_schema&quot; &quot;demo_schema&quot; {
  database = snowflake_database.demo_db.name
  name     = &quot;DEMO_SCHEMA&quot;
  comment  = &quot;Schema for Snowflake Terraform demo&quot;
}
</div></code></pre>
<p>Then commit the changes and push them to your GitHub repository. Because of the continuous integration trigger we created in the YAML definition, your workflow should have automatically started a new run. Toggle back to your GitHub and open up the &quot;Actions&quot; page. From there open up the most recent workflow run and view the logs. Go through the same steps you did in the previous section to confirm that the new <code>DEMO_SCHEMA</code> has been deployed successfully.</p>
<p>Congratulations, you now have a working CI/CD pipeline with Terraform and Snowflake!</p>
<!-- ------------------------ -->
<h2 id="advanced-actions-workflow">Advanced Actions Workflow</h2>
<p>In the previous sections we created and tested a simple GitHub Actions workflow with Terraform. This section provides a more advanced workflow that you can test out. This one adds the capability for having Terraform validate and plan a change before it's actually deployed. This pipeline adds CI triggers that cause it to run when a Pull Request (PR) is created/updated. During that process it will run a <code>terraform plan</code> and stick the results in the PR itself for easy review. Please give it a try!</p>
<pre class="hljs"><code><div>name: &quot;Snowflake Terraform Demo Workflow&quot;

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  snowflake-terraform-demo:
    name: &quot;Snowflake Terraform Demo Job&quot;
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        if: github.event_name == 'pull_request'
        run: terraform plan -no-color
        continue-on-error: true

      - uses: actions/github-script@0.9.0
        if: github.event_name == 'pull_request'
        env:
          PLAN: &quot;terraform\n${{ steps.plan.outputs.stdout }}&quot;
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style 🖌\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ⚙️\`${{ steps.init.outcome }}\`
            #### Terraform Validation 🤖\`${{ steps.validate.outcome }}\`
            #### Terraform Plan 📖\`${{ steps.plan.outcome }}\`
            
            &lt;details&gt;&lt;summary&gt;Show Plan&lt;/summary&gt;
            
            \`\`\`\n
            ${process.env.PLAN}
            \`\`\`
            
            &lt;/details&gt;
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`${{ env.tf_actions_working_dir }}\`, Workflow: \`${{ github.workflow }}\`*`;
            
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' &amp;&amp; github.event_name == 'push'
        run: terraform apply -auto-approve
</div></code></pre>
<p>This worklow was adapted from <a href="https://learn.hashicorp.com/tutorials/terraform/github-actions">Automate Terraform with GitHub Actions</a>.</p>
<!-- ------------------------ -->

</body>

</html>